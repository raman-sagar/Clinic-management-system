<!-- doctor-dashboard.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doctor Dashboard</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <h1>Doctor Dashboard</h1>
      <button id="logout">Logout</button>
      <h2>Pending Visits...</h2>
      <ul id="pendingVisits"></ul>
      <h2>Patient History</h2>
      <input type="text" id="searchPhone" placeholder="Search by Phone" />
      <button id="searchHistory">Search</button>
      <ul id="patientHistory"></ul>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        onSnapshot,
        doc,
        updateDoc,
        getDocs,
        getDoc,
        runTransaction,
      } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBHfNo5NSC1gVpLvEx4Ibs0EZBl_APulok",
        authDomain: "clinic-management-system-a9234.firebaseapp.com",
        projectId: "clinic-management-system-a9234",
        storageBucket: "clinic-management-system-a9234.firebasestorage.app",
        messagingSenderId: "408982581016",
        appId: "1:408982581016:web:79006c91101829de4b386d",
        measurementId: "G-5GYGHEDP06",
      };
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      // console.log("Firebase initialized", app);
      const auth = getAuth(app);
      // console.log("Auth initialized", auth);
      const db = getFirestore(app);
      // console.log("Firestore initialized", db);

      const pendingVisitsList = document.getElementById("pendingVisits");
      const patientHistoryList = document.getElementById("patientHistory");
      const searchPhone = document.getElementById("searchPhone"); //inputfield
      const searchHistoryBtn = document.getElementById("searchHistory"); //search-button
      const logoutBtn = document.getElementById("logout");

      // Check if logged in
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // User is signed in
          console.log("User is signed in", user.uid);
        } else {
          // No user is signed in
          window.location.href = "index.html";
        }
      });
      // Logout
      logoutBtn.addEventListener("click", async () => {
        await signOut(auth);
        window.location.href = "login.html";
      });

      // Load pending visits (without prescription)
      const pendingQuery = query(
        collection(db, "visits"),
        where("prescription", "==", "")
      );
      onSnapshot(pendingQuery, (snapshot) => {
        pendingVisitsList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const visit = docSnap.data();
          const li = document.createElement("li");
          li.innerHTML = `Token: ${visit.token} - Phone: ${visit.phone};`;
          const detailsBtn = document.createElement("button");
          detailsBtn.textContent = "View Details & Add Prescription";
          detailsBtn.addEventListener("click", async () => {
            const patientDoc = await getDoc(
              doc(db, "patients", visit.patientId)
            );
            const patient = patientDoc.data();
            const prescription = prompt("Enter Prescription:", "");
            if (prescription) {
              await updateDoc(doc(db, "visits", docSnap.id), { prescription });
              alert("Prescription added");
            }
          });
          li.appendChild(detailsBtn);
          pendingVisitsList.appendChild(li);
        });
      });

      // Search patient history
      searchHistoryBtn.addEventListener("click", async () => {
        const phone = searchPhone.value;
        if (!phone) return;
        const patientQuery = query(
          collection(db, "patients"),
          where("phone", "==", phone)
        );
        const patientDocs = await getDocs(patientQuery);
        patientHistoryList.innerHTML = "";
        if (patientDocs.empty) {
          patientHistoryList.innerHTML = "<li>No patient found</li>";
          return;
        }
        const patientId = patientDocs.docs[0].id;
        const visitsQuery = query(
          collection(db, "visits"),
          where("patientId", "==", patientId)
        );
        const visitsDocs = await getDocs(visitsQuery);
        visitsDocs.forEach((visitDoc) => {
          const visit = visitDoc.data();
          const li = document.createElement("li");
          li.textContent = `Token: ${visit.token}, Date: ${
            visit.date
          }, Prescription: ${visit.prescription || "None"}, Bill: ${
            visit.bill || "None"
          };`;
          patientHistoryList.appendChild(li);
        });
      });
    </script>
  </body>
</html>
